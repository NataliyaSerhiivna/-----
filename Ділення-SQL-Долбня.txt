--Долбня
--Вивести студентів, які купили усі сорти певної ціни N
WITH Сорти_ціни AS ( 
SELECT id_coрта 
FROM copr 
WHERE вартість =N 
), 
Куплені_сорти AS ( 
SELECT купив.id_студента, COUNT(DISTINCT купив.id_сорта) AS куплено 
FROM купив 
JOIN Сорти_ціни ON купив.id_сорта Сорти_ціни.id_сорта 
GROUP BY купив.id_студента 
), 
Кількість_усіх_сортів АЅ ( 
SELECT COUNT(*) AS total FROM Сорти ціни 
) 
SELECT студент.id_студента, студент. прізвище, студент.рік вступу 
FROM студент 
JOIN Куплені_сорти ON студент.id_студента Куплені_сорти.id_студента 
JOIN Кількість усіх_сортів ON Куплені сорти куплено Кількість_усіх_сортів.total;


--Знаходить студентів, які купили всі сорти певної ціни N і тільки їх
WITH Сорти_ціни AS ( 
SELECT id_сорта 
FROM copt 
WHERE вартість = N 
). 
Куплені_сорти AS ( 
SELECT купив.id_студента, COUNT(DISTINCT купив.id_сорта) AS куплено 
FROM купив 
JOIN Сорти_ціни ON купив.id_сорта Сорти_ціни.id_сорта 
GROUP BY купив.id_студента 
), 
Загальна кількість_сортів AS ( 
SELECT COUNT(*) AS total FROM Сорти_ціни 
), 
Купив_тільки_ці_сорти AS ( 
SELECT купив.id_студента 
FROM купив 
LEFT JOIN Сорти_ціни ON купив.id_сорта Сорти_ціни.id_сорта 
WHERE Сорти_ціни.id_сорта IS NULL 
GROUP BY купив.id_студента 
) 
SELECT студент.id_студента, студент. прізвище, студент. рік вступу 
FROM студент 
JOIN Куплені_сорти ON студент.id_студента Куплені_сорти.id_студента 
JOIN Загальна кількість_сортів ON Куплені сорти. куплено Загальна_кількість_сортів.total 
LEFT JOIN Купив_тільки_ці_сорти ON студент.id_студента Купив_тільки_ці_сорти.id_студента 
WHERE Купив_тільки_ці_сорти.id_студента IS NULL;


--Знаходить студентів, які купили сорти, дешевші або рівні N.
SELECT s.ID_студента, s.Прізвище, ѕ.Рік_вступу 
FROM Студент в 
WHERE NOT EXISTS ( 
SELECT ID_cорта 
FROM COPT 
WHERE Вартість <= N 
EXCEPT 
SELECT k.ID_сорта 
FROM Купівля к 
WHERE k.ID_студента = s.ID_студента 
);